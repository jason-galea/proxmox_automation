all:
  vars: # Global vars
    network: 172.26.0
    gateway: "{{ network }}.1"
    domain: test.lan
    dns: "{{ network }}.{{ hostvars['pihole'].id }}" # This not used during creation
    inventory_dir: "{{ ansible_inventory_sources[0] | dirname }}" # SUPER useful
    password: "{{ lookup('file', inventory_dir + '/password.txt') }}"
    required_packages: [git, curl, htop, neofetch] # :)

    prox_host: "{{ network }}.2"
    prox_user: root@pam
    prox_password: "{{ password }}"

  hosts:
    prox:
      fqdn: "{{ inventory_hostname }}.{{ domain }}"

      ansible_user: root
      ansible_host: "{{ prox_host }}"

  children:
    infra_cts:
      hosts:
        pihole:
          id: "160"
          required_packages: [curl,unzip,idn2,sqlite3,dns-root-data,netcat,lighttpd,php-common,php-cgi,php-sqlite3,php-xml,php-intl,php-json,git]
        # proxy:
        #   id : "161"
    service_cts:
      hosts:
        # portainer:
        #   id: "170"
        apache:
          id: "171"
        emby:
          id: "172"
          ct_cores: 4
          ct_memory: 2048
          ct_swap: 512
          port: "8096" # HTTP
          # port: "8920" # HTTPS
        # wekan:
        #   id: "173"
        #   port: "3001"
    vpn_cts:
      hosts:
        # radarr:
        #   id: "181"
        #   user: "admin"
    templates:
      hosts:
        # template:
        #   id: "200"
    all_cts:
      children:
        infra_cts:
        service_cts:
        vpn_cts:
        templates:
      vars: # Default vars for all CTs
        ### Misc.
        ip: "{{ network }}.{{ id }}"
        fqdn: "{{ inventory_hostname }}.{{ domain }}"
        user: "{{ inventory_hostname }}"
        # This ^^^ seems redundant, but if we use "inventory_hostname" in the playbook instead,
        # we are unable to change usernames on a per host basis.
        # For example, radarr/sonarr/lidarr do NOT want the user to be created in advance,
        # as they do it themselves during installation.
        # In that case the username cannot match the hostname.
        port: "80"

        ### CT Creation
        ct_node: prox
        ct_state: present
        ct_bridge: vmbr0
        ct_ip: "{{ network }}.{{ id }}"
        ct_netif: '{"net0":"name=eth0,bridge={{ ct_bridge }},firewall=1,type=veth,ip={{ ip }}/24,gw={{ gateway }}"}'
        ct_ostemplate: "local:vztmpl/ubuntu-21.10-standard_21.10-1_amd64.tar.zst"
        # ct_ostemplate: local:vztmpl/ubuntu-21.04-standard_21.04-1_amd64.tar.zst # For Proxmox 6.x
        ct_hostname: "{{ inventory_hostname }}"
        ct_password: "{{ password }}"
        ct_pubkey: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        ct_cores: 2
        ct_memory: 512 # MB
        ct_swap: 100 # MB
        ct_disk: 8 # GB
        ct_storage: local-lvm
        ct_unprivileged: yes
        ct_onboot: yes
        ct_features:
        - nesting=1
        
        ### Ansible
        ansible_user: "{{ inventory_hostname }}"
        ansible_host: "{{ ip }}"
        
