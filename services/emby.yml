---
- name: "Deploy Emby"
  hosts: emby
  gather_facts: no
  vars:
    # TODO: Detect URL + DEB from https://emby.media/linux-server.html
    emby_version: 4.6.7.0
    emby_deb: emby-server-deb_{{ emby_version }}_amd64.deb
    emby_url: https://github.com/MediaBrowser/Emby.Releases/releases/download/{{ emby_version }}/{{ emby_deb }}
  tasks:

  - name: Check if DEB file exists
    stat:
      path: "{{ emby_deb }}"
    register: deb_stat
  - name: "Download DEB file, if it doesn't exist"
    get_url:
      url: "{{ emby_url }}"
      dest: "~/{{ emby_deb }}"
    when: not deb_stat.stat.exists

  - name: "Install from DEB"
    apt:
      deb: "~/{{ emby_deb }}"
    register: install
  - debug:
      var: install.stdout
    when: install.stdout != ''

  - name: "Verify webserver at http://{{ ansible_host }}:{{ port }} "
    wait_for:
      port: "{{ port }}"
      # delay: 3

  # TODO: Configure the following:
  # 
  # - name: "Configure libraries"
    # command: ""