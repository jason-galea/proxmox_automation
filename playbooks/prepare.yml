---
- name: "Prepare containers"
  hosts: prox_hosts
  gather_facts: no
  vars:
    password: "{{ lookup('file', '../password.txt') }}"
    ansible_user: root # Only needed to configure passwordless sudo
  tasks:

  - name: "Create new user(s)"
    command: "useradd -s /usr/bin/bash -m -G sudo -p {{ password }} {{ user }}"
    # TODO: If user already exists, pass
    # when: ???

  # - name: "Grant passwordless sudo"
  #   copy:
  #     dest: "/etc/sudoers.d/{{ user }}"
  #     content: "{{ user }}  ALL=(ALL) NOPASSWD:ALL"
  #     mode: "0644"
  #   # TODO: If file already exists, pass
  #   # when: ???

  - name: "Grant passwordless sudo"
    lineinfile:
      path: /etc/sudoers
      state: present
      regexp: '^%sudo'
      line: '%sudo ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s' # O___O it works, ok
      # TODO: If line already exists in visudo, pass
      # when: ???

  - name: "Create ~/.ssh"
    file:
      path: "/home/{{ user }}/.ssh"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: "0700"
    # TODO: If $HOME/.ssh already exists, pass
    # when: ???

  - name: "Authorise localhost SSH key"
    copy:
      src: ~/.ssh/id_rsa.pub # localhost
      dest: "/home/{{ user }}/.ssh/authorized_keys" # remote host
      # content: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: "0600"
    # TODO: If ssh key already exists, pass
    # when: ???


  ### Apt
  # - name: "apt install"
  #   apt:
  #     pkg:
  #     - htop
  #     - tree
  #     update_cache: yes
  #   register: apt_install
  # - debug: var=apt_install.stdout

  # - name: "apt dist-upgrade"
  #   apt:
  #     upgrade: dist
  #   register: apt_dist_upgrade
  # - debug: var=apt_dist_upgrade.stdout


  ### TODO: Auto-update
  # - name: "Configure apt auto update"