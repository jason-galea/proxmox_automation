# ansible-playbook -i inv.yml services/pihole.yml

# Expects host "pihole" to be deployed according to inv.yml

---
- name: "Deploy Pihole"
  hosts: pihole
  gather_facts: no
  vars:
    setupvars: "/etc/pihole/setupVars.conf"
  tasks:

    ### Install Pihole (MANUAL):
    # https://docs.pi-hole.net/main/basic-install/
    # sudo apt update -y && sudo apt install -y git
    # git clone --depth 1 https://github.com/pi-hole/pi-hole.git Pi-hole
    # cd "Pi-hole/automated install/"
    # sudo bash basic-install.sh
    ### Steps for interactive install script:
    # 1. "OK"
    # 2. "OK"
    # 3. Static IP? --> "YES"
    # 4. Upstream DNS? --> Cloudflare (DNSSEC) --> (TAB) --> "OK"
    # 5. Block list? --> (TAB to accept default "StevenBlacks") --> "OK"
    # 6. Do you want a web interface? --> (TAB to accept default "ON") --> "OK"
    # 7. Install lighttpd? --> (TAB to accept default "ON") --> "OK"
    # 8. Log queries? --> (TAB to accept default "ON") --> "OK"
    # 9. Privacy mode? --> (TAB to accept default "0 Show Everything") --> "OK" # More info: (https://docs.pi-hole.net/ftldns/privacylevels/)
    ### ...wait for script to finish...
    # 10. Install complete!

    ### Install Pihole (SETUPVARS)
    # https://discourse.pi-hole.net/t/pi-hole-as-part-of-a-post-installation-script/3523
    # https://discourse.pi-hole.net/t/what-is-setupvars-conf-and-how-do-i-use-it/3533
    # sudo apt update -y && sudo apt install -y git
    # git clone --depth 1 https://github.com/pi-hole/pi-hole.git Pi-hole
    # cd "Pi-hole/automated install/"
    ### Populate setupVars.conf
    # sudo mkdir /etc/pihole/
    # sudo echo -n abc##123 | sha256sum | awk '{print $1}' | sha256sum | awk '{print $1}' >> /etc/pihole/setupVars.conf
    # sudo echo -e "WEBPASSWORD=$(cat /etc/pihole/setupVars.conf)" > /etc/pihole/setupVars.conf # Prepend
    # sudo echo "IPV4_ADDRESS=172.26.0.161/24" >> /etc/pihole/setupVars.conf
    # sudo echo "QUERY_LOGGING=true" >> /etc/pihole/setupVars.conf
    # sudo echo "INSTALL_WEB=true" >> /etc/pihole/setupVars.conf
    # sudo echo "PIHOLE_DNS_1=1.1.1.1" >> /etc/pihole/setupVars.conf
    # sudo echo "PIHOLE_DNS_2=1.0.0.1" >> /etc/pihole/setupVars.conf
    # sudo echo "DNSSEC=true" >> /etc/pihole/setupVars.conf
    # sudo echo "TEMPERATUREUNIT=C" >> /etc/pihole/setupVars.conf
    ### Install
    # sudo bash basic-install.sh

  - name: "Download install script"
    get_url:
      url: https://install.pi-hole.net
      dest: ~/basic-install.sh
    register: download
  - debug: var=download.stdout
    
  # - name: "Populate {{ setupvars }}"

  # - name: "Install Pihole"
  #   command: "bash ~/basic-install.sh"
  #   become: yes
  #   register: install
  # - debug: var=install.stdout
  
  # - name: "Verify webserver"
  #   uri:
  #     # url: "http://{{ ansible_host }}:{{ port }}" #
  #     url: "http://{{ ansible_host }}/admin"
  #     delay: 3