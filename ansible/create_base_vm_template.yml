---
- name: Create base VM template
  hosts: base-vm
  gather_facts: false
  tasks:

    - name: Check if base VM template already exists
      vars: ### NOTE: Workaround, only required when container isn't online
        ansible_ssh_private_key_file: "{{ hostvars['prox'].ansible_ssh_private_key_file }}"
      delegate_to: prox
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          qm list | grep {{ id }}
        executable: /bin/bash
      register: check_if_base_vm_exists
      changed_when: check_if_base_vm_exists.rc != 0
      failed_when: false ### Ignore failures, we just want the stdout

    - name: "Include role 'prox_kvm' with tasks from 'check_create_install_packages'"
      loop:
        - check_create_install_packages
        - template
      ansible.builtin.include_role:
        name: prox_kvm
        tasks_from: check_create_install_packages
      when: check_if_base_vm_exists.stdout == ""
