### TODO: Add -v (--verbose) flag?

### TODO: SPLIT BASE PACKAGES --> REQUIRED PACKAGES & RESTRUCTURE deploy.yml

---
### DNS Workaround
- name: "Connect via IP, not DNS name"
  hosts: all
  gather_facts: no
  tasks:
  - set_fact:
      ansible_host: "{{ ip }}"

### Create/discover base template
- hosts: base
  gather_facts: no
  tasks:
  - name: "Check if base template exists"
    delegate_to: prox
    shell: "find {{ template_dir }} | grep 'vzdump.*{{ id }}.*tar' | cat"
    register: check

  - name: "PASS: Skipping..."
    meta: end_play
    when: check.stdout != ""

  - name: "FAIL: Creating base template"
    include_role:
      name: "{{ item }}"
    with_items:
    - create
    - packages
    - backup
    when: check.stdout == ""

### Deploy infrastructure
- name: "Deploy infrastructure containers"
  hosts: infrastructure
  gather_facts: no
  roles:
  - create
  - prepare
  - firewall # Some base packages have listeners, so only allow specified ports

### Configure infrastructure
- import_playbook: "services/pihole.yml" ### TODO: Check & skip if already installed
# - import_playbook: "services/proxy.yml"
# - import_playbook: "services/ca.yml"

### Revert DNS Workaround
- hosts: all
  gather_facts: no
  tasks:
  - set_fact:
      ansible_host: "{{ fqdn }}"

### Deploy services
- name: "Prepare service containers"
  hosts: all_services
  gather_facts: no
  roles:
  - create
  - prepare
  - firewall

### Configure services
- import_playbook: "services/apache.yml"
- import_playbook: "services/emby.yml"
# - import_playbook: "services/wekan.yml"
